# -*- coding: utf-8 -*-
"""
Created on Mon Apr 30 14:39:38 2018

@author: Pikari
"""

import mysql.connector
import datetime as dt
from WindPy import w
w.start()

def create_table(table_name, columns, data_type):
    try:
        temp = ''
        for i in range(len(columns)):
           temp += columns[i] + ' ' + data_type[i] + ', '   
        temp = 'create table ' + table_name + '(' + temp[:-2] + ')'
        cursor.execute(temp)
        print('\033[0;32m' + table_name + ' has been nearly created.' + '\033[0m')
    except:
        print('\033[0;31m' + table_name + ' had already existed' + '\033[0m')

def insert_table(table_name, columns, data):
    try:
        sql = 'insert into ' + table_name + ' ('  + '%s, ' * len(columns) + ')'
        sql = sql[:-3] + sql[-1]
        sql = sql%tuple(columns) + ' values ' + '(' +'%s, ' * len(columns) + ')'
        sql = sql[:-3] + sql[-1]
        cursor.execute(sql, data)
        conn.commit()
        print('\033[0;32m' + table_name + ' content has been updated competely' + '\033[0m')
    except:
        print('\033[0;31m Error in updating ' + table_name + '. Please update after a trading day.' + '\033[0m')

if __name__ == '__main__':
    conn = mysql.connector.connect(host='******', user='root', password='******', database='******')
    cursor = conn.cursor()
    table_name = 'index_component'
    cursor.execute('show tables')
    tables = cursor.fetchall()
    useful_index_code_list = ['000001.SH', '000002.SH', '000003.SH', '000004.SH', '000005.SH', '000006.SH', '000007.SH', '000008.SH', '000009.SH', '000010.SH', '000011.SH', '000012.SH', '000013.SH', '000015.SH', '000016.SH', '000017.SH', '000018.SH', '000019.SH', '000020.SH', '000021.SH', '000022.SH', '000025.SH', '000026.SH', '000027.SH', '000028.SH', '000029.SH', '000030.SH', '000031.SH', '000032.SH', '000033.SH', '000034.SH', '000035.SH', '000036.SH', '000037.SH', '000038.SH', '000039.SH', '000040.SH', '000041.SH', '000042.SH', '000043.SH', '000044.SH', '000045.SH', '000046.SH', '000047.SH', '000048.SH', '000049.SH', '000050.SH', '000051.SH', '000052.SH', '000053.SH', '000054.SH', '000055.SH', '000056.SH', '000057.SH', '000058.SH', '000059.SH', '000060.SH', '000061.SH', '000062.SH', '000063.SH', '000064.SH', '000065.SH', '000066.SH', '000067.SH', '000068.SH', '000069.SH', '000070.SH', '000071.SH', '000072.SH', '000073.SH', '000074.SH', '000075.SH', '000076.SH', '000077.SH', '000078.SH', '000079.SH', '000090.SH', '000091.SH', '000092.SH', '000093.SH', '000094.SH', '000095.SH', '000096.SH', '000097.SH', '000098.SH', '000099.SH', '000100.SH', '000101.SH', '000102.SH', '000103.SH', '000104.SH', '000105.SH', '000106.SH', '000107.SH', '000108.SH', '000109.SH', '000110.SH', '000111.SH', '000112.SH', '000113.SH', '000114.SH', '000115.SH', '000116.SH', '000117.SH', '000118.SH', '000119.SH', '000120.SH', '000121.SH', '000122.SH', '000123.SH', '000125.SH', '000126.SH', '000128.SH', '000129.SH', '000130.SH', '000131.SH', '000132.SH', '000133.SH', '000134.SH', '000135.SH', '000136.SH', '000137.SH', '000138.SH', '000139.SH', '000141.SH', '000142.SH', '000145.SH', '000146.SH', '000147.SH', '000148.SH', '000149.SH', '000150.SH', '000151.SH', '000152.SH', '000153.SH', '000155.SH', '000158.SH', '000159.SH', '000160.SH', '000161.SH', '000162.SH', '000300.SH', '000802.SH', '000805.SH', '000806.SH', '000807.SH', '000808.SH', '000814.SH', '000816.SH', '000819.SH', '000821.SH', '000823.SH', '000827.SH', '000828.SH', '000832.SH', '000833.SH', '000841.SH', '000842.SH', '000846.SH', '000847.SH', '000849.SH', '000850.SH', '000852.SH', '000853.SH', '000854.SH', '000855.SH', '000856.SH', '000857.SH', '000858.SH', '000901.SH', '000903.SH', '000904.SH', '000905.SH', '000906.SH', '000908.SH', '000909.SH', '000910.SH', '000911.SH', '000912.SH', '000913.SH', '000914.SH', '000917.SH', '000918.SH', '000919.SH', '000922.SH', '000925.SH', '000928.SH', '000931.SH', '000932.SH', '000933.SH', '000934.SH', '000935.SH', '000939.SH', '000940.SH', '000944.SH', '000950.SH', '000951.SH', '000952.SH', '000957.SH', '000958.SH', '000959.SH', '000961.SH', '000963.SH', '000964.SH', '000966.SH', '000969.SH', '000971.SH', '000974.SH', '000975.SH', '000977.SH', '000978.SH', '000979.SH', '000982.SH', '000983.SH', '000984.SH', '000986.SH', '000987.SH', '000989.SH', '000990.SH', '000991.SH', '000992.SH', '000993.SH', '000998.SH', '000999.SH', '399001.SZ', '399002.SZ', '399003.SZ', '399004.SZ', '399005.SZ', '399006.SZ', '399007.SZ', '399008.SZ', '399009.SZ', '399010.SZ', '399011.SZ', '399012.SZ', '399013.SZ', '399015.SZ', '399016.SZ', '399017.SZ', '399018.SZ', '399100.SZ', '399101.SZ', '399102.SZ', '399103.SZ', '399106.SZ', '399107.SZ', '399108.SZ', '399231.SZ', '399232.SZ', '399233.SZ', '399234.SZ', '399235.SZ', '399236.SZ', '399237.SZ', '399238.SZ', '399239.SZ', '399240.SZ', '399241.SZ', '399242.SZ', '399243.SZ', '399244.SZ', '399248.SZ', '399249.SZ', '399297.SZ', '399298.SZ', '399299.SZ', '399300.SZ', '399301.SZ', '399302.SZ', '399303.SZ', '399306.SZ', '399307.SZ', '399310.SZ', '399311.SZ', '399312.SZ', '399313.SZ', '399314.SZ', '399315.SZ', '399316.SZ', '399317.SZ', '399318.SZ', '399319.SZ', '399320.SZ', '399321.SZ', '399322.SZ', '399324.SZ', '399326.SZ', '399328.SZ', '399330.SZ', '399333.SZ', '399335.SZ', '399337.SZ', '399339.SZ', '399341.SZ', '399344.SZ', '399346.SZ', '399348.SZ', '399350.SZ', '399351.SZ', '399352.SZ', '399353.SZ', '399354.SZ', '399355.SZ', '399356.SZ', '399357.SZ', '399358.SZ', '399359.SZ', '399360.SZ', '399361.SZ', '399362.SZ', '399363.SZ', '399364.SZ', '399365.SZ', '399366.SZ', '399367.SZ', '399368.SZ', '399369.SZ', '399370.SZ', '399371.SZ', '399372.SZ', '399373.SZ', '399374.SZ', '399375.SZ', '399376.SZ', '399377.SZ', '399378.SZ', '399379.SZ', '399380.SZ', '399381.SZ', '399382.SZ', '399383.SZ', '399384.SZ', '399385.SZ', '399386.SZ', '399387.SZ', '399388.SZ', '399389.SZ', '399390.SZ', '399391.SZ', '399392.SZ', '399393.SZ', '399394.SZ', '399395.SZ', '399396.SZ', '399397.SZ', '399398.SZ', '399399.SZ', '399400.SZ', '399401.SZ', '399402.SZ', '399403.SZ', '399404.SZ', '399405.SZ', '399406.SZ', '399407.SZ', '399408.SZ', '399409.SZ', '399410.SZ', '399411.SZ', '399412.SZ', '399413.SZ', '399415.SZ', '399417.SZ', '399418.SZ', '399419.SZ', '399420.SZ', '399422.SZ', '399423.SZ', '399427.SZ', '399428.SZ', '399429.SZ', '399431.SZ', '399432.SZ', '399433.SZ', '399434.SZ', '399435.SZ', '399436.SZ', '399437.SZ', '399438.SZ', '399439.SZ', '399440.SZ', '399441.SZ', '399481.SZ', '399550.SZ', '399551.SZ', '399552.SZ', '399553.SZ', '399554.SZ', '399555.SZ', '399556.SZ', '399557.SZ', '399602.SZ', '399604.SZ', '399606.SZ', '399608.SZ', '399610.SZ', '399611.SZ', '399612.SZ', '399613.SZ', '399614.SZ', '399615.SZ', '399616.SZ', '399617.SZ', '399618.SZ', '399619.SZ', '399620.SZ', '399621.SZ', '399622.SZ', '399623.SZ', '399624.SZ', '399625.SZ', '399626.SZ', '399627.SZ', '399628.SZ', '399629.SZ', '399630.SZ', '399631.SZ', '399632.SZ', '399633.SZ', '399634.SZ', '399635.SZ', '399636.SZ', '399637.SZ', '399638.SZ', '399639.SZ', '399640.SZ', '399641.SZ', '399642.SZ', '399643.SZ', '399644.SZ', '399645.SZ', '399646.SZ', '399647.SZ', '399648.SZ', '399649.SZ', '399650.SZ', '399651.SZ', '399652.SZ', '399653.SZ', '399654.SZ', '399655.SZ', '399656.SZ', '399657.SZ', '399658.SZ', '399659.SZ', '399660.SZ', '399661.SZ', '399662.SZ', '399663.SZ', '399664.SZ', '399665.SZ', '399666.SZ', '399667.SZ', '399668.SZ', '399669.SZ', '399670.SZ', '399671.SZ', '399672.SZ', '399673.SZ', '399674.SZ', '399675.SZ', '399676.SZ', '399677.SZ', '399678.SZ', '399679.SZ', '399680.SZ', '399681.SZ', '399682.SZ', '399683.SZ', '399684.SZ', '399685.SZ', '399686.SZ', '399687.SZ', '399688.SZ', '399689.SZ', '399690.SZ', '399691.SZ', '399692.SZ', '399693.SZ', '399694.SZ', '399695.SZ', '399696.SZ', '399697.SZ', '399698.SZ', '399699.SZ', '399701.SZ', '399702.SZ', '399703.SZ', '399704.SZ', '399705.SZ', '399706.SZ', '399707.SZ', '399802.SZ', '399803.SZ', '399804.SZ', '399805.SZ', '399806.SZ', '399807.SZ', '399808.SZ', '399809.SZ', '399810.SZ', '399811.SZ', '399812.SZ', '399813.SZ', '399814.SZ', '399817.SZ', '399901.SZ', '399903.SZ', '399904.SZ', '399905.SZ', '399908.SZ', '399909.SZ', '399910.SZ', '399911.SZ', '399912.SZ', '399913.SZ', '399914.SZ', '399917.SZ', '399918.SZ', '399919.SZ', '399922.SZ', '399925.SZ', '399928.SZ', '399931.SZ', '399932.SZ', '399933.SZ', '399934.SZ', '399935.SZ', '399939.SZ', '399944.SZ', '399950.SZ', '399951.SZ', '399952.SZ', '399957.SZ', '399958.SZ', '399959.SZ', '399961.SZ', '399963.SZ', '399964.SZ', '399965.SZ', '399966.SZ', '399967.SZ', '399969.SZ', '399970.SZ', '399971.SZ', '399972.SZ', '399973.SZ', '399974.SZ', '399975.SZ', '399976.SZ', '399977.SZ', '399978.SZ', '399979.SZ', '399982.SZ', '399983.SZ', '399986.SZ', '399987.SZ', '399989.SZ', '399990.SZ', '399991.SZ', '399992.SZ', '399993.SZ', '399994.SZ', '399995.SZ', '399996.SZ', '399997.SZ', '399998.SZ']
    columns = useful_index_code_list
    columns = ['index_' + i[:6] for i in columns]
    data_type = ['text null'] + ['boolean null'] * len(columns)
    
    create_table(table_name, ['stock_code'] + columns, data_type)
    
    for stock_code in tables:
        data = [stock_code[0]] + [None] * len(columns)
        insert_table(table_name, ['stock_code'] + columns, data)
    
    for index_code in useful_index_code_list:    
        component = w.wset("sectorconstituent","date=%s;windcode=%s"%(dt.datetime.now().date(), index_code))
        for stock_code in component.Data[1]:
            cursor.execute('update %s set %s = 1 where stock_code = "%s"'%(table_name, 'index_' + index_code[:6], 'stock_' + stock_code[:6]))
            conn.commit()
            #Q:多久commit一次比较合适？

'''
import re
import urllib.request  
def scratch_index_component(index_code):
    url = 'http://www.sse.com.cn/market/sseindex/indexlist/s/i' + index_code + '/const_list.shtml'
    url = urllib.request.urlopen(url).read().decode('utf-8')
    return re.findall('\(\d\d\d\d\d\d\)', url)
   
for index_code in columns[1:]:
    component = scratch_index_component(index_code[-6:])
    for stock_code in component:
        cursor.execute('update %s set %s = 1 where stock_code = "%s"'%(table_name, index_code, 'stock_' + stock_code[1:-1]))
        conn.commit()
'''